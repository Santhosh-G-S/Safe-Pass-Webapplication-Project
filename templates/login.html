<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Assuming Bootstrap is provided by a link like this or in layout.html -->
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">

    <title>Safe Pass | Login</title>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-lg-5 col-md-7 col-sm-9">
                <div class="card shadow-lg border-0 rounded-4">
                    <div class="card-body p-5">

                        {% if get_flashed_messages() %}
                        <div class="alert alert-primary text-center mb-4" role="alert">
                            {{ get_flashed_messages() | join(" ") }}
                        </div>
                        {% endif %}

                        <!-- Logo and Title -->
                        <div class="text-center mb-4">
                            <img src="static/Safe Pass.png" alt="Safe Pass Logo" class="img-fluid mb-3" style="max-width: 100px;">
                            <h2 class="fw-bold mb-2">Welcome Back!</h2>
                            <p class="text-muted">Log in to Safe Pass</p>
                        </div>

                        <!-- Login Form -->
                        <form action="/login" method="post">
                            <!-- Email Input -->
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" name="email" id="floatingInput" placeholder="name@example.com" required>
                                <label for="floatingInput">Email address</label>
                            </div>

                            <!-- Password Input -->
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" name="password" id="floatingPassword" placeholder="Password" autocomplete="off" required>
                                <label for="floatingPassword">Password</label>
                            </div>

                            <!-- Forgot Password Link -->
                            <div class="text-end mb-3">
                                <a href="#" id="reset" class="text-decoration-none small">Forgot Password?</a>
                            </div>

                            <!-- Login Button -->
                            <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">Log In</button>
                        </form>

                        <!-- Divider -->
                        <div class="position-relative my-4">
                            <hr>
                            <span class="position-absolute top-50 start-50 translate-middle badge bg-secondary">OR</span>
                        </div>

                        <!-- Google Login Button -->
                        <button id="google-login-btn" type="button" class="btn btn-outline-danger btn-lg w-100 mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-google me-2" viewBox="0 0 16 16">
                                <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/>
                            </svg>
                            Continue with Google
                        </button>

                        <!-- Register Link -->
                        <p class="text-center mb-0">
                            <span class="text-muted">New user?</span>
                            <a href="{{ url_for('register') }}" class="text-decoration-none fw-semibold">Create an account</a>
                        </p>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, sendPasswordResetEmail, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKqUq06zpiLJ1r-p63nxjnc-vn0gUAlXk",
            authDomain: "safe-pass-c9c13.firebaseapp.com",
            projectId: "safe-pass-c9c13",
            storageBucket: "safe-pass-c9c13.firebasestorage.app",
            messagingSenderId: "1046763012364",
            appId: "1:1046763012364:web:b0a4ef8bbcd3a6c2724929",
            measurementId: "G-ND1DCMNXEV"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        auth.languageCode = 'en';
        const provider = new GoogleAuthProvider();

        // Forgot Password Handler
        const reset = document.getElementById("reset");
        reset.addEventListener("click", function(event) {
            event.preventDefault();

            // Get email from the input field with correct ID
            const email = document.getElementById("floatingInput").value;

            if (!email) {
                alert("Please enter your email address first");
                return;
            }

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert("Password reset email sent! Check your inbox.");
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;

                    if (errorCode === 'auth/user-not-found') {
                        alert("No account found with this email address");
                    } else if (errorCode === 'auth/invalid-email') {
                        alert("Invalid email address");
                    } else {
                        alert("Error: " + errorMessage);
                    }
                    console.error("Password reset error:", error);
                });
        });

        // Google Login Handler
        const googleLogin = document.getElementById("google-login-btn");
        if (googleLogin) {
            googleLogin.addEventListener("click", async function() {
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;

                    // Get the ID token
                    const idToken = await user.getIdToken();

                    // Send token to Flask backend
                    const response = await fetch('/firebase-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ idToken: idToken })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Redirect to check page
                        window.location.href = data.redirect;
                    } else {
                        alert('Login failed: ' + (data.error || 'Unknown error'));
                    }

                } catch (error) {
                    console.error('Error during sign in:', error);

                    if (error.code === 'auth/popup-closed-by-user') {
                        // User closed the popup, no need to show error
                        return;
                    }

                    alert('Sign in failed: ' + error.message);
                }
            });
        }
    </script>
</body>
</html>
